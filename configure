#!/bin/sh

show_help()
{
	echo configure help:
	echo "--help               show this help"
	echo "--no-tcl             disable TCL scripting support"
	echo "                     even if uid != euid"
}

if [ "$1" = "--help" ]; then
	show_help
	exit 0
fi

CC=${CC:=cc}

echo build byteorder.c...
$CC byteorder.c -o byteorder || exit 1

INSTALL_MANPATH="/usr/share/man"
BYTEORDER=`./byteorder -m`

echo create byteorder.h...
cat > byteorder.h <<EOF
#ifndef __BYTEORDER_H
#define __BYTEORDER_H

EOF
echo \#ifndef $BYTEORDER >> byteorder.h
echo \#define $BYTEORDER >> byteorder.h
echo \#endif /\* $BYTEORDER \*/ >> byteorder.h
cat >> byteorder.h <<EOF

/* Endianness bitfield macros for GCC compatibility */
#if !defined(__LITTLE_ENDIAN_BITFIELD) && !defined(__BIG_ENDIAN_BITFIELD)
#  if defined(__BYTE_ORDER__) && defined(__ORDER_LITTLE_ENDIAN__) && defined(__ORDER_BIG_ENDIAN__)
#    if __BYTE_ORDER__ == __ORDER_LITTLE_ENDIAN__
#      define __LITTLE_ENDIAN_BITFIELD 1
#    elif __BYTE_ORDER__ == __ORDER_BIG_ENDIAN__
#      define __BIG_ENDIAN_BITFIELD 1
#    endif
#  elif defined(BYTE_ORDER_LITTLE_ENDIAN)
#    define __LITTLE_ENDIAN_BITFIELD 1
#  elif defined(BYTE_ORDER_BIG_ENDIAN)
#    define __BIG_ENDIAN_BITFIELD 1
#  endif
#endif

#endif /* __BYTEORDER_H */
EOF

CONFIGOSTYPE=LINUX

#
# TCL detection
#
for TCLPATH_TRY in "/usr/bin/"
do
	for TCLVER_TRY in "8.6" "8.5" "8.4" "8.3" "8.2" "8.1" "8.0"
	do
		if [ -z $TCLSH ]
		then
			TCLSH_TRY=${TCLPATH_TRY}tclsh${TCLVER_TRY}
			if [ -f $TCLSH_TRY ]
			then
				TCLSH=$TCLSH_TRY
				echo "===> Found Tclsh in: $TCLSH"
			fi
		fi
	done
done
if [ -f $TCLSH ]
then
	TCL_VER=`echo puts \\$tcl_version | $TCLSH -`
	USE_TCL='-DUSE_TCL'
	TCL_LIB="-ltcl${TCL_VER}"
	if [ -e /usr/include/tcl${TCL_VER} ]
	then
		TCL_INC="-I/usr/include/tcl${TCL_VER}"
	elif [ -e /usr/include/tcl.h ]
	then
		TCL_INC=""
	elif [ -e /usr/local/include/tcl${TCL_VER} ]
	then
		TCL_INC="-I/usr/local/include/tcl${TCL_VER}"
	else
		USE_TCL=""
		TCL_LIB=""
		echo "==> WARNING: no Tcl header files found!"
	fi
fi
if [ -n "$USE_TCL" ]
then
	for LIBDIR in /usr/lib/aarch64-linux-gnu /usr/lib/arm-linux-gnueabihf /usr/lib/x86_64-linux-gnu /usr/lib; do
		if [ -d "$LIBDIR" ]; then
			LIBPOSTFIX=$(ls -1 "$LIBDIR" 2>/dev/null | grep 'libtcl[0-9]' | grep '\.so' | sed -e 's/\.so.*//g' -e 's/libtcl//g' | sort -r | head -1)
			if [ -n "$LIBPOSTFIX" ]; then
				TCL_LIB="-L$LIBDIR -ltcl${LIBPOSTFIX} -lm -lpthread"
				break
			fi
		fi
	done
fi

#
# configurable stuff
#
PCAP="PCAP=-lpcap"
PCAP_INCLUDE=""

for ARG in $*; do
	case "$ARG" in
		*"--no-tcl")
			USE_TCL=""
			TCL_VER=""
			TCL_INC=""
			TCL_LIB=""
			;;
	esac
done

echo --------------------------------------
echo system type: $CONFIGOSTYPE
echo
echo "LIBPCAP      : $PCAP"
echo "PCAP_INCLUDE : $PCAP_INCLUDE"
echo "MANPATH      : $INSTALL_MANPATH"
echo "USE_TCL      : $USE_TCL"
echo "TCL_VER      : $TCL_VER"
echo "TCL_INC      : $TCL_INC"
echo "LIBTCL       : $TCL_LIB"
echo "TCLSH        : $TCLSH"
echo
echo "(to modify try configure --help)"
echo --------------------------------------

echo creating Makefile...
sed	-e "s^@PCAP@^$PCAP^g" \
	-e "s^@PCAP_INCLUDE@^$PCAP_INCLUDE^g" \
	-e "s^@MANPATH@^$INSTALL_MANPATH^g" \
	-e "s^@USE_TCL@^$USE_TCL^g" \
	-e "s^@TCL_INC@^$TCL_INC^g" \
	-e "s^@TCL_VER@^$TCL_VER^g" \
	-e "s^@TCL_LIB@^$TCL_LIB^g" \
	<Makefile.in > Makefile

#
#
#

cat > systype.h <<EOF
#ifndef __SYSTYPE_H
#define __SYSTYPE_H

EOF
echo \#define OSTYPE_${CONFIGOSTYPE} >> systype.h
cat >> systype.h <<EOF

#endif /* SYSTYPE_H */
EOF

echo creating dependences...
$CC -MM *.c > .depend

echo now you can try \`make\'
